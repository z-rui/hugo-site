---
date: 2015-05-20T01:51:00+08:00
title: "IUP代码生成器以及re2c补丁一枚"
---

最近虽然写SQLite图形前端的计划还没有什么进展，但是准备工作已经做起来了。在这过程中常常有意外收获。

在计划使用IUP作为图形界面库的时候，因为LED使用的机制过老，而Lua绑定又要增加新的依赖。（我的经验是，一旦用了IUP的Lua绑定，就会不知不觉地把和GUI不相关的逻辑代码写在Lua里。）所以我打算自己写一个新的GUI代码生成器。它的特点是：

- 使用IUP的新接口，例如`IupSetCallback`, `IupSetAttributeHandle`。
- 不使用`IupSetHandle`给每个IUP对象绑定一个全局名称。
- 生成纯C代码，不依赖Lua。

目前这个项目已经[托管在GitHub](https://github.com/z-rui/dlg)，仍在开发中。最新的master分支已经基本能用。

写这个程序其实就是发明一个小型的专用语言，所以又要和Lex & Yacc这样的元老打交道。最初我打算手写词法分析器和语法分析器，然而只有词法分析器被我手写出来。语法分析器我用[Lemon](http://www.hwaci.com/sw/lemon/)生成。Lemon和Yacc的语法并不兼容，但好在前者是公有领域内的软件，编译起来也很方便。

Lemon生成的是LALR(1)语法分析器，对语法似乎有很大的限制，总之并不能像我想象地那样好地工作。GNU Bison可以生成更加强大的语法分析器而且和Yacc更加兼容，但我没有尝试。

后来我嫌词法分析器手写也太麻烦，索性用Flex改成自动生成。这就是master分支的最新状态。

我现在还创建了一个新的分支，用[re2c](http://re2c.org/)生成词法分析器。re2c的优点是：

- 生成直接C代码构造的DFA，而不是把各个状态保存在一张表里(Flex是这么做的)。所以运行速度很快。
- 可以在任意位置创造任意个DFA，输入/输出机制可以自定义，比Flex更加灵活。

缺点是：

- re2c和Flex的语法也不兼容。
- re2c用的没有Flex广泛。
- re2c的文档少得可怜。
- re2c不产生任何辅助代码，没有Flex容易上手。

Flex的确很容易上手，只需要指定词法规则，在程序中调用`yylex()`，然后随意地读取`yytext`就可以得到词法分析的结果。至于输入输出、内存管理，Flex都会自动生成相应的代码，帮你搞定。而re2c不生成这些辅助的代码，所以需要自己动手。

最后说说re2c的补丁。re2c的词法规则是放在形如`/*!re2c ... */`的注释块中的。据说也可以使用`%{ ... %}`作为界限符，但是我试了一下，Segmentation fault。

原因是re2c自己的词法分析器写的不对，里边有一个硬编码的字符串长度，只适用于前一种形式。[补丁](https://sourceforge.net/p/re2c/patches/27/)已提交到SourceForge。
